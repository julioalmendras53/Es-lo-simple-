<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Libro + Diccionario</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
      display: flex;
      gap: 1.5rem;
    }

    #contenedor {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      width: 100%;
    }

    #libro {
      line-height: 1.6;
      text-align: justify;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #definicion {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .palabra { cursor: pointer; }
    .palabra:hover { text-decoration: underline; }

    .palabra.resaltada {
      color: blue;
      font-weight: bold;
    }

    h1 { grid-column: 1 / -1; margin-top: 0; }

    .sin-def {
      color: #999;
      font-style: italic;
    }
  </style>
</head>

<body>
<div id="contenedor">

  <h1>Libro del Infinito</h1>

  <!-- TEXTO DEL LIBRO -->
  <pre id="texto-libro" style="display:none;">
4296 El poder del estado en infinito no tiene sentido.
4297 El infinito de poder puede.
4298 El infinito puede que amanezca mañana en ese campo hipotético.
4299 El infinito podrá vencer a dios en su propio juego, el fin.
4300 No puedo aguantar las vejaciones que trae tener un fin.
  </pre>

  <div id="libro"></div>

  <div id="definicion">
    <h2>Definición</h2>
    <p>Haz clic en una palabra del libro para ver su definición.</p>
  </div>

</div>

<script>
/* -------------------------------------
   FUNCIONES DE NORMALIZACIÓN
------------------------------------- */
function normalizarPalabra(raw = "") {
  return raw
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9ñ]/gi, "");
}

/* -------------------------------------
   DICCIONARIO COMPLETO (FUNCIONAL)
------------------------------------- */
const diccionario = {

  agujero: {
    definiciones: [
      "1.Abertura o hueco en una superficie o en un sólido.",
      "2.De las agujas.",
      "3.Falta inmotivada de plata en una empresa."
    ]
  },

  negro: {
    definiciones: [
      "1.Ausencia total o casi de reflejo luminoso.",
      "2.De color negro.",
      "3.Perteneciente a la raza negra.",
      "4.Ritual en que se invoca al demonio.",
      "5.Del color de carbón, de oscuridad total o la boca de un túnel",
      "6.Muy bronceado.",
      "7.Modo de tratamiento de quienes se quieren.",
      "8.Persona que hace un trabajo intelectual por encargo de otra haciendo todo el esfuerzo.",
      "9.Estado de ánimo triste o pesimista.",
      "10.Género de cine que de trama policiaca en entorno violento."
    ]
  },

  de: {
    definiciones: [
      "1.Indica pertenencia. La paciencia de job.",
      "2.Locuciones adverbiales: Almorzó de pie.",
      "3.Procedencia: Vengo de Aranjuez.",
      "4.Material: vestido de seda.",
      "5.Contenido: vaso de agua.",
      "6.Asunto: trata de la guerra.",
      "7.Causa: murió de viruelas.",
      "8.Naturaleza: hombre de valor.",
      "9.Desde: de Madrid a Toledo.",
      "10.Lejor de pensar.",
      "11.Hipotético: de saberlo vendría.",
      "12.Perífrasis: acaba de pasar.",
      "13.Tiempo: de madrugada.",
      "14.Refuerzo: el bueno de Juan.",
      "15.Ilación: de esto se sigue.",
      "16.Rapidez: beber de un trago.",
      "17.Lástima: ay de los vencidos.",
      "18.A por la 16.",
      "19.Comparación.",
      "20.Para. Gorro de dormir.",
      "21.Por miedo."
    ]
  },

  amanecer: {
    definiciones: [
      "1.Comenzar a verse la luz.",
      "2.Estar en un lugar al amanecer.",
      "3.Nacer figurado.",
      "4.Pasar la noche en vela.",
      "5.Alumbre."
    ]
  },

  manana: {
    definiciones: [
      "1.Parte del día entre amanecer y mediodía.",
      "2.Medianoche a mediodía.",
      "3.El tiempo futuro.",
      "4.El día siguiente."
    ]
  },

  en: {
    definiciones: [
      "1.Tiempo, lugar o modo.",
      "2.Sobre.",
      "3.Ocupación.",
      "4.Tránsito.",
      "5.Tan pronto como.",
      "6.Límite de movimiento."
    ]
  },

  ese: {
    definiciones: [
      "1.Cercano al interlocutor.",
      "2.Mencionado.",
      "3.Menosprecio.",
      "4.Persona que se ha marchado."
    ]
  },

  campo: {
    definiciones: [
      "1.Terreno extenso.",
      "2.Terreno trabajable.",
      "3.Campiña.",
      "4.Terreno de juego.",
      "5.Mitad del campo en fútbol.",
      "6.Término de municipio.",
      "7.Campo de conocimiento.",
      "8.Campo eléctrico.",
      "9.Campo de base de datos.",
      "10.Comarca ocupada por ejército.",
      "11.Ejército.",
      "12.Campo visual."
    ]
  },

  hipotetico: { definicion: "Perteneciente a la hipótesis." },

  vencer: {
    definiciones: [
      "1.Batir al enemigo.",
      "2.Ser superior.",
      "3.Controlar emociones.",
      "4.Superar obstáculos.",
      "5.Atraer a alguien al propio deseo.",
      "6.Subir a un sitio áspero.",
      "7.Cumplirse plazo.",
      "8.Ganar en pelea física."
    ]
  },

  supervitaminar: {
    definiciones: [
      "1.Potenciar algo.",
      "2.Hipertrofiar.",
      "3.Dopar con trampa."
    ]
  },

  "poder-verbo": {
    definiciones: [
      "1.Tener vía libre para hacer a lo quiera.",
      "2.Expresa posibilidad.",
      "3.Ser capaz de vencer a otro.",
      "4.Sufrir impertinencias."
    ]
  },

  "poder-sustantivo": {
    definiciones: [
      "1.Facultad para hacer.",
      "2.Gobierno.",
      "3.Fuerza física de animales.",
      "4.Permiso legal cedido."
    ]
  },

  infinito: {
    definiciones: [
      "1.Que no tiene fin.",
      "2.Ilimitado.",
      "3.Lo que carece de límite."
    ]
  },

  estado: { definiciones: ["1.Condición.", "2.Organización política."] },
  sentido: { definiciones: ["1.Significado.", "2.Función fisiológica."] },
  fin: { definiciones: ["1.Término.", "2.Propósito."] },
  tener: { definiciones: ["1.Poseer.", "2.Sujetar.", "3.Ocurrir."] },
  traer: { definiciones: ["1.Llevar hacia aquí.", "2.Causar."] },
  vejaciones: { definiciones: ["1.Maltrato.", "2.Humillación persistente."] },

  dios: { definiciones: ["1.Ser supremo."] }
};


/* -------------------------------------
   ÍNDICE NORMALIZADO
------------------------------------- */
const diccionarioIdx = {};
for (const [k, v] of Object.entries(diccionario)) {
  diccionarioIdx[normalizarPalabra(k)] = v;
}


/* -------------------------------------
   DETECCIÓN PODER
------------------------------------- */
function tipoPoder(tokens, idx) {
  const palabra = normalizarPalabra(tokens[idx] || "");
  const prev = normalizarPalabra(tokens[idx - 1] || "");
  const next = normalizarPalabra(tokens[idx + 1] || "");

  const conjugaciones = [
    "puedo","puedes","puede","podemos","pueden",
    "podia","podias","podiamos","podian",
    "podra","podras","podremos","podran",
    "podria","podrias","podriamos","podrian",
    "pude","pudiste","pudo","pudimos","pudieron",
    "pueda","puedas","podamos","puedan",
    "pudiera","pudieras","pudieramos","pudieran",
    "pudiese","pudieses","pudiesemos","pudiesen"
  ];
  if (conjugaciones.includes(palabra)) return "verbo";

  const determinantes = [
    "el","la","los","las","un","una","unos","unas",
    "mi","mis","tu","tus","su","sus",
    "este","esta","estos","estas",
    "ese","esa","esos","esas",
    "aquel","aquella","aquellos","aquellas",
    "del","al"
  ];
  if (palabra === "poder" && determinantes.includes(prev)) return "sustantivo";

  if (palabra === "poder" && prev === "de") {
    if (next.endsWith("ar") || next.endsWith("er") || next.endsWith("ir"))
      return "verbo";
    return "sustantivo";
  }

  if (palabra === "poder" && (next.endsWith("ar") || next.endsWith("er") || next.endsWith("ir")))
    return "verbo";

  return null;
}


/* -------------------------------------
   LEMATIZACIÓN
------------------------------------- */

const verbLemmaMap = {
  "puedo": "poder", "puedes": "poder", "puede": "poder",
  "podemos": "poder", "pueden": "poder",
  "podia": "poder", "podias": "poder", "podiamos": "poder", "podian": "poder",
  "podra": "poder", "podras": "poder", "podremos": "poder", "podran": "poder",
  "podria": "poder", "podrias": "poder", "podriamos": "poder", "podrian": "poder",
  "pude": "poder", "pudiste": "poder", "pudo": "poder", "pudimos": "poder", "pudieron": "poder",
  "pueda": "poder", "puedas": "poder", "podamos": "poder", "puedan": "poder",
  "pudiera": "poder", "pudieras": "poder", "pudieramos": "poder", "pudieran": "poder",
  "pudiese": "poder", "pudieses": "poder", "pudiesemos": "poder", "pudiesen": "poder",
  "creo": "crear"
};

const cliticEndings = [
  "melo","mela","melos","melas",
  "telo","tela","telos","telas",
  "selo","sela","selos","selas",
  "noslo","nosla","noslos","noslas",
  "oslo","osla","oslos","oslas",
  "me","te","se","lo","la","los","las","le","les","nos","os"
];

function stripClitics(word) {
  let w = word;
  let changed = true;
  while (changed) {
    changed = false;
    for (const cl of cliticEndings) {
      if (w.endsWith(cl) && w.length > cl.length + 1) {
        w = w.slice(0, -cl.length);
        changed = true;
        break;
      }
    }
  }
  return w;
}

function guessInfinitive(w) {
  if (verbLemmaMap[w]) return verbLemmaMap[w];

  if (w.endsWith("se")) {
    const base = w.slice(0, -2);
    if (diccionario[base]) return base;
  }

  if (w.endsWith("o")) {
    const stem = w.slice(0, -1);
    const candAr = stem + "ar";
    if (diccionario[candAr]) return candAr;
  }

  if (w.endsWith("aba") || w.endsWith("abas") || w.endsWith("aban")) {
    const stem = w.replace(/aba(s|n)?$/, "");
    const candAr = stem + "ar";
    if (diccionario[candAr]) return candAr;
  }

  if (w.endsWith("ando")) {
    const stem = w.slice(0, -4);
    const cand = stem + "ar";
    if (diccionario[cand]) return cand;
  }

  if (w.endsWith("iendo")) {
    const stem = w.slice(0, -5);
    const candEr = stem + "er";
    const candIr = stem + "ir";
    if (diccionario[candEr]) return candEr;
    if (diccionario[candIr]) return candIr;
  }

  if (w.endsWith("ar") || w.endsWith("er") || w.endsWith("ir"))
    return w;

  return w;
}

/* -------------------------------------
   TOKENIZACIÓN Y CONSTRUCCIÓN DEL LIBRO
------------------------------------- */

let tokensLibro = [];

function prepararLibro() {
  const fuente = document.getElementById("texto-libro").innerText;
  const contenedorLibro = document.getElementById("libro");

  const tokens = fuente.split(/(\s+)/);
  tokensLibro = [];

  contenedorLibro.innerHTML = "";
  let indiceToken = 0;

  tokens.forEach(token => {
    if (/^\s+$/.test(token)) {
      contenedorLibro.appendChild(document.createTextNode(token));
    } else {
      const span = document.createElement("span");
      span.textContent = token;
      span.className = "palabra";

      const idx = indiceToken;
      span.addEventListener("click", () => mostrarDefinicion(token, idx));

      tokensLibro.push(token);
      indiceToken++;

      contenedorLibro.appendChild(span);
    }
  });
}

/* -------------------------------------
   CONTEXTO
------------------------------------- */

function obtenerContexto(idx) {
  let inicio = idx;
  let fin = idx;

  while (inicio > 0) {
    const t = tokensLibro[inicio];
    if (/[.!?]/.test(t)) {
      inicio++;
      break;
    }
    inicio--;
  }

  while (fin < tokensLibro.length - 1) {
    const t = tokensLibro[fin];
    if (/[.!?]/.test(t)) break;
    fin++;
  }

  return tokensLibro.slice(inicio, fin + 1).join(" ");
}

/* -------------------------------------
   PALABRAS CLAVE
------------------------------------- */

function limpiarTexto(texto) {
  return texto
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9ñ\s]/gi, " ");
}

const stopwords = new Set([
  "el","la","los","las","un","una","unos","unas",
  "lo","al","del",
  "de","a","en","por","para","con","sin","sobre",
  "y","o","u","ni",
  "que","se","su","sus","mi","mis","tu","tus",
  "este","esta","estos","estas","ese","esa","esos","esas",
  "aquel","aquella","aquellos","aquellas"
]);

function palabrasClave(texto) {
  return limpiarTexto(texto)
    .split(/\s+/)
    .filter(w => w.length > 2 && !stopwords.has(w));
}

/* -------------------------------------
   SINÓNIMOS
------------------------------------- */

const sinonimos = {
  vencer: ["ganar","derrotar","triunfar","vencer"],
  sufrir: ["aguantar","soportar","tolerar","padecer","sufrir"],
  impertinencias: ["vejaciones","abusos","humillaciones","maltratos"],
  posibilidad: ["posibilidad","quizas","talvez","acaso","hipotetico","probable","eventual"]
};

const pesosCategoria = {
  verbo: 2,
  sustantivo: 1,
  adjetivo: 0,
  adverbio: -1,
  pronombre: -2,
  determinante: -3,
  preposicion: -4,
  conjuncion: -5,
  interjeccion: -6
};

const categorias = {
  infinito: ["sustantivo","adjetivo"],
  poder: ["sustantivo","verbo"],
  amanecer: ["verbo"],
  manana: ["adverbio","sustantivo"],
  campo: ["sustantivo"],
  hipotetico: ["adjetivo"],
  vencer: ["verbo"],
  dios: ["sustantivo"],
  propio: ["adjetivo"],
  juego: ["sustantivo"],
  fin: ["sustantivo"],
  aguantar: ["verbo"],
  vejaciones: ["sustantivo"],
  traer: ["verbo"],
  tener: ["verbo"],
  estado: ["sustantivo"],
  sentido: ["sustantivo"]
};


/* -------------------------------------
   EXPANSIÓN DE SINÓNIMOS
------------------------------------- */
function expandirConSinonimos(p) {
  const base = p.toLowerCase();
  const lista = [base];
  if (sinonimos[base]) lista.push(...sinonimos[base]);
  return lista;
}

/* -------------------------------------
   ELECCIÓN DE DEFINICIÓN
------------------------------------- */
function elegirDefinicionConExplicacion(definiciones, contexto) {
  const ctxWords = palabrasClave(contexto);
  const setCtx = new Set(ctxWords);

  let mejorIndice = 0;
  let mejorScore = -Infinity;
  let mejorExplicacion = { exactas: [], sinonimos: [], categorias: [], score: 0 };

  definiciones.forEach((def, idx) => {
    const palabrasDef = palabrasClave(def);
    let score = 0;
    let exactas = [];
    let sinos = [];
    let catsUsadas = [];

    palabrasDef.forEach(p => {
      const base = p.toLowerCase();
      let coincid = null;

      if (setCtx.has(base)) {
        coincid = base;
        score += 2;
        exactas.push(base);
      } else {
        const variantes = expandirConSinonimos(base);
        for (const v of variantes) {
          if (setCtx.has(v)) {
            coincid = v;
            score += 1;
            sinos.push({ palabraDef: base, coincidencia: v });
            break;
          }
        }
      }

      if (coincid) {
        const catList = categorias[coincid];
        if (catList) {
          for (const cat of catList) {
            if (pesosCategoria[cat] !== undefined) {
              const peso = pesosCategoria[cat];
              score += peso;
              catsUsadas.push({ palabra: coincid, categoria: cat, peso });
            }
          }
        }
      }
    });

    if (score > mejorScore) {
      mejorScore = score;
      mejorIndice = idx;
      mejorExplicacion = { exactas, sinonimos: sinos, categorias: catsUsadas, score };
    }
  });

  return { indice: mejorIndice, explicacion: mejorExplicacion };
}

/* -------------------------------------
   RESALTADO
------------------------------------- */

function limpiarResaltado() {
  document.querySelectorAll("#libro .palabra.resaltada")
    .forEach(e => e.classList.remove("resaltada"));
}

function resaltarCoincidencias(rawWord) {
  const objetivo = normalizarPalabra(rawWord);
  document.querySelectorAll("#libro .palabra").forEach(span => {
    const textoSpan = span.textContent || "";
    if (normalizarPalabra(textoSpan) === objetivo)
      span.classList.add("resaltada");
  });
}

/* -------------------------------------
   MUESTRA DE DEFINICIÓN
------------------------------------- */

function obtenerClaveVerbal(rawWord, idx) {
  const original = rawWord.trim();

  if (original.toLowerCase().startsWith("dios")) return "dios";

  if (original === "creó" || original === "Creó")
    return diccionario["crear"] ? "crear" : original;

  let w = normalizarPalabra(original);
  w = stripClitics(w);
  const lemma = guessInfinitive(w);

  if (lemma === "poder") {
    const tipo = tipoPoder(tokensLibro, idx);
    if (tipo === "verbo") return "poder-verbo";
    if (tipo === "sustantivo") return "poder-sustantivo";
    return "poder-verbo";
  }

  return lemma;
}

function mostrarDefinicion(rawWord, idx) {
  const clave = obtenerClaveVerbal(rawWord, idx);

  const entrada =
    diccionario[clave] ||
    diccionarioIdx[normalizarPalabra(clave)];

  const panel = document.getElementById("definicion");

  limpiarResaltado();
  resaltarCoincidencias(rawWord);

  if (!entrada) {
    panel.innerHTML = `
      <h2>${rawWord}</h2>
      <p class="sin-def">
        Esta palabra no tiene definición aún.
        <br><small>(clave interna: ${clave})</small>
      </p>`;
    return;
  }

  let definiciones = [];
  if (entrada.definicion) definiciones.push(entrada.definicion);
  if (entrada.definiciones) definiciones.push(...entrada.definiciones);

  const contexto = obtenerContexto(idx);

  let { indice: indiceElegido, explicacion } =
    elegirDefinicionConExplicacion(definiciones, contexto);

  const htmlDefs = definiciones
    .map((d, i) => `<p${i === indiceElegido ? ' style="color:blue;"' : ''}>${d}</p>`)
    .join("");

  let htmlExp = "";
  const partes = [];

  if (explicacion.exactas.length)
    partes.push("Coincidencias exactas: <b>" + explicacion.exactas.join(", ") + "</b>.");

  if (explicacion.sinonimos.length)
    partes.push("Sinónimos: <b>" +
      explicacion.sinonimos.map(s => `${s.palabraDef} ↔ ${s.coincidencia}`).join(", ") +
      "</b>.");

  if (partes.length)
    htmlExp = `<hr><p style="font-size:0.9em;"><strong>Razón:</strong> ${partes.join(" ")}</p>`;

  panel.innerHTML = `<h2>${rawWord}</h2>${htmlDefs}${htmlExp}`;
}

/* -------------------------------------
   INICIO
------------------------------------- */

prepararLibro();

</script>

</body>
</html>
