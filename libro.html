<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Libro + Diccionario</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
      display: flex;
      gap: 1.5rem;
    }

    #contenedor {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      width: 100%;
    }

    #libro {
      line-height: 1.6;
      text-align: justify;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #definicion {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .palabra {
      cursor: pointer;
    }

    .palabra:hover {
      text-decoration: underline;
    }

    /* Cuando una palabra est√° resaltada por el diccionario */
    .palabra.resaltada {
      color: blue;
      font-weight: bold;
    }

    h1 {
      grid-column: 1 / -1;
      margin-top: 0;
    }

    h2 {
      margin-top: 0;
    }

    .sin-def {
      color: #999;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="contenedor">
    <h1>Libro del Infinito</h1>

    <!-- Texto del libro (oculto, se procesa con JS) -->
    <pre id="texto-libro" style="display:none;">
4297 El infinito de poder puede. 4298 El infinito puede que amanezca ma√±ana en ese campo hipot√©tico. 4299 El infinito podr√° vencer a dios en su propio juego, el fin. 4300 No puedo aguantar las vejaciones que trae tener un fin.
    </pre>

    <!-- Zona visible del libro con palabras clicables -->
    <div id="libro"></div>

    <!-- Zona donde se mostrar√° la definici√≥n -->
    <div id="definicion">
      <h2>Definici√≥n</h2>
      <p>Haz clic en una palabra del libro para ver su definici√≥n de tu diccionario web.</p>
    </div>
  </div>

  <script>
    // üî§ Normalizar palabra: min√∫sculas, sin tildes, sin puntuaci√≥n
    function normalizarPalabra(raw = "") {
      return raw
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // quita tildes
        .replace(/[^a-z0-9√±]/gi, "");                    // deja solo letras y n√∫meros b√°sicos + √±
    }

    // -----------------------
    // MINI DICCIONARIO BASE
    // -----------------------
    const diccionario = {

      escobeta: {
        definiciones: [
          "1.Escoba en miniatura.",
          "2.Cepillo para los atuendos.",
          "3.Escoba de cerdas.",
          "4.Escoba de ra√≠z de zacat√≥n, corta y dura.",
          "5.Mech√≥n de cerdas que aparece en el papo a pavos avejentados."
        ]
      },

      simular: {
        definiciones: [
          "1.Imitar la existencia de algo de manera fiel.",
          "2.Aparentar en tecnolog√≠a artificialmente el funcionamiento de sistema."
        ]
      },

      agujero: {
        definiciones: [
          "1.Abertura o hueco en una superficie o en un s√≥lido.",
          "2.De las agujas.",
          "3.Falta inmotivada de plata en una empresa."
        ]
      },

      negro: {
        definiciones: [
          "1.Ausencia total o casi de reflejo luminoso.",
          "2.De color negro.",
          "3.Perteneciente a la raza negra.",
          "4.Ritual en que se invoca al demonio.",
          "5.Del color de carb√≥n, de oscuridad total o la boca de un t√∫nel",
          "6.Muy bronceado.",
          "7.Modo de tratamiento de quienes se quieren.",
          "8.Persona que hace un trabajo intelectual por encargo de otra haciendo todo el esfuerzo.",
          "9.Estado de √°nimo triste o pesimista.",
          "10.G√©nero de cine que de trama policiaca en entorno violento."
        ]
      },

      de: {
        definiciones: [
          "1.Indica pertenencia. La paciencia de job.",
          "2.Para hacer diferentes locuciones adverbiales de modo. Almorz√≥ de pie.",
          "3.Indica de d√≥nde procede alguien. Vengo de Aranjuez.",
          "4.Indica el material del que est√° creado algo. El vestido de seda.",
          "5.Para indicar lo que tiene algo. Un vaso de agua.",
          "6.Indica asunto. Este libro trata de la √∫ltima guerra.",
          "7.Indica la causa de algo. Muri√≥ de viruelas.",
          "8.Usado para expresar la naturaleza de algo. Hombre de valor.",
          "9.Desde. De Madrid a Toledo.",
          "10.Precedida de adverbio y seguida de infinitivo. Lejos de pensar.",
          "11.Seguido de infinitivo con peso de hip√≥tesis. De saberlo antes, habr√≠a venido.",
          "12.Llenado de verbos. Acaba de pasar.",
          "13.Usado con ciertos nombres para indicar el tiempo en que sucede. Lo hizo de madrugada.",
          "14.Para refortalecer un calificativo. El bueno de juan.",
          "15.Usado como indicaci√≥n de ilacion. De esto se sigue.",
          "16.Indica la veloz ejecuci√≥n de algo. Se bebi√≥ de un trago la tisana.",
          "17.Expresion de l√°stima. Ay de los vencidos.",
          "18.Llenado de preposiciones. A por la 16.",
          "19.Para introducir una comparaci√≥n. He comido m√°s de lo debido.",
          "20.Para. Gorro de dormir.",
          "21.Por. Lo hice de miedo."
        ]
      },

      amanecer: {
        definiciones: [
          "1.Comenzar a verse la luz del d√≠a.",
          "2.Estar en un lugar o situacion al verse la luz del d√≠a.",
          "3.Nacer en figurado.",
          "4.Recorrer la noche insomne.",
          "5.Alumbre."
        ]
      },

      manana: {
        definiciones: [
          "1.Parte del d√≠a entre el amanecer y el mediod√≠a.",
          "2.Parte del d√≠a entre la medianoche y el mediod√≠a.",
          "3.Tiempo que viene.",
          "4.El d√≠a inmediatamente posterior al de hoy."
        ]
      },

      en: {
        definiciones: [
          "1.Indica en qu√© tiempo, lugar o modo se realiza lo que habla el verbo. Pedro est√° en madrid.",
          "2.Sobre. El rey le ha dado una pensi√≥n en la renta del tabaco.",
          "3.Indica la ocupaci√≥n de alguien. Trabajar en bioqu√≠mica.",
          "4.Indica situaci√≥n de tr√°nsito.",
          "5.Tan pronto como.",
          "6.Denota el l√≠mite de alg√∫n verbo de movimiento. Entrar en casa."
        ]
      },

      ese: {
        definiciones: [
          "1.Que est√° cercano del individuo con el que se conversa.",
          "2.Que se menciona o se mencionara.",
          "3.Se√±ala menosprecio por algo o por persona.",
          "4.Se√±ala una persona que est√° lejana o que se march√≥."
        ]
      },

      campo: {
        definiciones: [
          "1.Terreno extenso a las afueras de pueblo.",
          "2.Terreno que puede trabajarse.",
          "3.En oposici√≥n a sierra, campi√±a.",
          "4.Terreno de juego donde se pr√°ctica deportes como el f√∫tbol.",
          "5.Mitad de terreno de f√∫tbol que se defiende.",
          "6.T√©rmino de municipio.",
          "7.Reino que puede ser imaginario sobre determinado conocimiento.",
          "8.Region del espacio en que est√° definida una magnitud, como el campo el√©ctrico.",
          "9.En una base de datos, espacio para almacenar informaci√≥n.",
          "10.Comarca ocupada por ej√©rcitos durante actos de guerra.",
          "11.Ej√©rcito.",
          "12.Redondel visual del ojo."
        ]
      },

      hipotetico: { definicion: "Perteneciente a la hip√≥tesis." },

      vencer: {
        definiciones: [
          "1.Batir al enemigo.",
          "2.Ser superior en comparaci√≥n.",
          "3.Sujetar las emociones reduciendolos a la raz√≥n.",
          "4.Superar estorbos.",
          "5.Atraer a otra persona a que siga su deseo.",
          "6.Lograr subir a una altura √°spera.",
          "7.Cumplirse un plazo.",
          "8.Triunfar en pelea f√≠sica."
        ]
      },

      supervitaminar: {
        definiciones: [
          "1.Potenciar algo por un agente.",
          "2.Hipertrofiar algo hasta lo grotesco.",
          "3.Dopar por trampa."
        ]
      },

      poder-verbo: {
        definiciones: [
          "1.Tener v√≠a libre para hacer a lo quiera.",
          "2.Expresa posibilidad de que ocurra algo.",
          "3.Ser capaz de vencer a otro.",
          "4.Ocupado de manera negativa: Sufrir las impertinencias de alguien."
        ]
      },

      poder-sustantivo: {
        definiciones: [
          "1.Facultad para hacer.",
          "2.Gobierno en un Estado.",
          "3.Capacidad f√≠sica de las bestias.",
          "4.Permiso que se cede de alguien a alguien."
        ]
      }
    };

    // √çndice auxiliar: mismas entradas pero con clave normalizada
    const diccionarioIdx = {};
    for (const [k, v] of Object.entries(diccionario)) {
      diccionarioIdx[normalizarPalabra(k)] = v;
    }

    // -----------------------------------------
    // DETECTAR SI "PODER" ES VERBO O SUSTANTIVO
    // -----------------------------------------
    function tipoPoder(tokens, idx) {
      const palabra = normalizarPalabra(tokens[idx] || "");
      const prev    = normalizarPalabra(tokens[idx - 1] || "");
      const next    = normalizarPalabra(tokens[idx + 1] || ""); // ‚Üê AQU√ç ESTABA EL ERROR

      // 1) Conjugaciones claras ‚Üí verbo
      const conjugaciones = [
        "puedo","puedes","puede","podemos","pueden",
        "podia","podias","podiamos","podian",
        "podra","podras","podremos","podran",
        "podria","podrias","podriamos","podrian",
        "pude","pudiste","pudo","pudimos","pudieron",
        "pueda","puedas","podamos","puedan",
        "pudiera","pudieras","pudieramos","pudieran",
        "pudiese","pudieses","pudiesemos","pudiesen"
      ];
      if (conjugaciones.includes(palabra)) return "verbo";

      // 2) Determinante/posesivo antes ‚Üí sustantivo
      const determinantes = [
        "el","la","los","las","un","una","unos","unas",
        "mi","mis","tu","tus","su","sus",
        "este","esta","estos","estas",
        "ese","esa","esos","esas",
        "aquel","aquella","aquellos","aquellas",
        "del","al"
      ];
      if (palabra === "poder" && determinantes.includes(prev)) return "sustantivo";

      // 3) "de poder" ‚Üí sustantivo normalmente,
      // salvo que vaya seguido de infinitivo (ha de poder hacer)
      if (palabra === "poder" && prev === "de") {
        if (next.endsWith("ar") || next.endsWith("er") || next.endsWith("ir")) {
          return "verbo";
        }
        return "sustantivo";
      }

      // 4) "poder" seguido de infinitivo ‚Üí verbo
      if (palabra === "poder" &&
          (next.endsWith("ar") || next.endsWith("er") || next.endsWith("ir"))) {
        return "verbo";
      }

      return null;
    }

    // ================================
    // LEMATIZADOR MUY SIMPLE DE VERBOS
    // ================================
    const verbLemmaMap = {
      // PODER
      "puedo": "poder", "puedes": "poder", "puede": "poder", "podemos": "poder",
      "pueden": "poder",
      "podia": "poder", "podias": "poder", "podiamos": "poder", "podian": "poder",
      "podra": "poder", "podras": "poder", "podremos": "poder", "podran": "poder",
      "podria": "poder", "podrias": "poder", "podriamos": "poder", "podrian": "poder",
      "pude": "poder", "pudiste": "poder", "pudo": "poder", "pudimos": "poder", "pudieron": "poder",
      "pueda": "poder", "puedas": "poder", "podamos": "poder", "puedan": "poder",
      "pudiera": "poder", "pudieras": "poder", "pudieramos": "poder", "pudieran": "poder",
      "pudiese": "poder", "pudieses": "poder", "pudiesemos": "poder", "pudiesen": "poder",

      // CREAR (caso especial)
      "creo": "crear"
    };

    // Pronombres encl√≠ticos al final de verbos, para cosas tipo "decirmelo".
    const cliticEndings = [
      "melo","mela","melos","melas",
      "telo","tela","telos","telas",
      "selo","sela","selos","selas",
      "noslo","nosla","noslos","noslas",
      "oslo","osla","oslos","oslas",
      "me","te","se","lo","la","los","las","le","les","nos","os"
    ];

    function stripClitics(word) {
      let w = word;
      let changed = true;
      while (changed) {
        changed = false;
        for (const cl of cliticEndings) {
          if (w.endsWith(cl) && w.length > cl.length + 1) {
            w = w.slice(0, -cl.length);
            changed = true;
            break;
          }
        }
      }
      return w;
    }

    function guessInfinitive(w) {
      // 1) Tabla de verbos irregulares frecuentes
      if (verbLemmaMap[w]) return verbLemmaMap[w];

      // 2) Infinitivo pronominal: vestirse -> vestir
      if (w.endsWith("se")) {
        const base = w.slice(0, -2);
        if (diccionario[base]) return base;
      }

      // 3) Formas en -o (hablo/creo) -> hablar/crear
      if (w.endsWith("o")) {
        const stem = w.slice(0, -1);
        const candAr = stem + "ar";
        if (diccionario[candAr]) return candAr;
      }

      // 4) Formas en -aba/-abas/-aban
      if (w.endsWith("aba") || w.endsWith("abas") || w.endsWith("aban")) {
        const stem = w.replace(/aba(s|n)?$/, "");
        const candAr = stem + "ar";
        if (diccionario[candAr]) return candAr;
      }

      // 5) Gerundios: creando -> crear, comiendo -> comer, viviendo -> vivir
      if (w.endsWith("ando")) {
        const stem = w.slice(0, -4);
        const cand = stem + "ar";
        if (diccionario[cand]) return cand;
      }
      if (w.endsWith("iendo")) {
        const stem = w.slice(0, -5);
        const candEr = stem + "er";
        const candIr = stem + "ir";
        if (diccionario[candEr]) return candEr;
        if (diccionario[candIr]) return candIr;
      }

      // 6) Si ya termina en -ar / -er / -ir, lo tomamos como infinitivo
      if (w.endsWith("ar") || w.endsWith("er") || w.endsWith("ir")) {
        return w;
      }

      return w;
    }

    // -----------------------------
    // TOKENS DEL LIBRO EN PANTALLA
    // -----------------------------
    let tokensLibro = [];

    // Obtiene la clave real del diccionario a partir de la palabra del libro
    function obtenerClaveVerbal(rawWord, indiceTokenReal = null) {
      const original = rawWord.trim();

      // Protecci√≥n: "dios" NO es un verbo
      if (original.toLowerCase().startsWith("dios")) {
        return "dios";
      }

      // Caso especial: "cre√≥" con tilde ‚Üí CREAR
      if (original === "cre√≥" || original === "Cre√≥") {
        if (diccionario["crear"]) return "crear";
      }

      // Normalizaci√≥n est√°ndar
      let w = normalizarPalabra(original);
      w = stripClitics(w);
      const lemma = guessInfinitive(w);

      // PODER con tratamiento especial
      if (lemma === "poder") {
        // Si viene el √≠ndice real del click, √∫salo
        let idx = indiceTokenReal;

        // Si no, busca por forma normalizada
        if (idx == null) {
          idx = tokensLibro.findIndex(t => normalizarPalabra(t) === "poder");
        }

        if (idx >= 0) {
          const tipoPod = tipoPoder(tokensLibro, idx);

          if (tipoPod === "verbo" && diccionario["poder-verbo"]) {
            return "poder-verbo";
          }
          if (tipoPod === "sustantivo" && diccionario["poder-sustantivo"]) {
            return "poder-sustantivo";
          }
        }

        // Fallback
        return "poder-verbo";
      }

      return lemma;
    }

    // -----------------------
    // MOTOR DE CONTEXTO
    // -----------------------
    function obtenerContexto(idx) {
      let inicio = idx;
      let fin = idx;

      // Hacia la izquierda hasta encontrar separador de frase
      while (inicio > 0) {
        const t = tokensLibro[inicio];
        if (/[.!?]/.test(t)) {
          inicio++;
          break;
        }
        inicio--;
      }

      // Hacia la derecha
      while (fin < tokensLibro.length - 1) {
        const t = tokensLibro[fin];
        if (/[.!?]/.test(t)) {
          break;
        }
        fin++;
      }

      return tokensLibro.slice(inicio, fin + 1).join(" ");
    }

    function limpiarTexto(texto) {
      return texto
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9√±\s]/gi, " ");
    }

    const stopwords = new Set([
      "el","la","los","las","un","una","unos","unas",
      "lo","al","del",
      "de","a","en","por","para","con","sin","sobre",
      "y","o","u","ni",
      "que","se","su","sus","mi","mis","tu","tus",
      "este","esta","estos","estas","ese","esa","esos","esas",
      "aquel","aquella","aquellos","aquellas"
    ]);

    function palabrasClave(texto) {
      return limpiarTexto(texto)
        .split(/\s+/)
        .filter(w => w.length > 2 && !stopwords.has(w));
    }

    const sinonimos = {
      // poder vencer a otro (def 3)
      vencer: ["ganar", "derrotar", "triunfar", "vencer"],

      // sufrir impertinencias (def 4)
      sufrir: ["aguantar", "soportar", "tolerar", "padecer", "sufrir"],
      impertinencias: ["vejaciones", "abusos", "humillaciones", "maltratos"],

      // expresar posibilidad (def 2)
      posibilidad: [
        "posibilidad",
        "quizas",
        "talvez",
        "acaso",
        "hipotetico",
        "probable",
        "eventual"
      ]
    };

    const pesosCategoria = {
      verbo: 2,
      sustantivo: 1,
      adjetivo: 0,
      adverbio: -1,
      pronombre: -2,
      determinante: -3,
      preposicion: -4,
      conjuncion: -5,
      interjeccion: -6
    };

    const categorias = {
      infinito: ["sustantivo", "adjetivo"],
      poder: ["sustantivo", "verbo"],
      amanecer: ["verbo"],
      manana: ["adverbio", "sustantivo"],
      campo: ["sustantivo"],
      hipotetico: ["adjetivo"],
      vencer: ["verbo"],
      dios: ["sustantivo"],
      propio: ["adjetivo"],
      juego: ["sustantivo"],
      fin: ["sustantivo"],
      aguantar: ["verbo"],
      vejaciones: ["sustantivo"],
      traer: ["verbo"],
      tener: ["verbo"],
      estar: ["verbo"],
      orillas: ["sustantivo"],
      agujero: ["sustantivo"],
      negro: ["adjetivo"],
      engullir: ["verbo"],
      absolutamente: ["adverbio"],

      buscar: ["verbo"],
      palabra: ["sustantivo"],
      contener: ["verbo"],
      algo: ["pronombre", "adverbio"],
      siempre: ["adverbio"],
      caer: ["verbo"],
      hacer: ["verbo"],
      todo: ["determinante"],
      pensamiento: ["sustantivo"],
      transformar: ["verbo"],
      idea: ["sustantivo"],
      problema: ["sustantivo"],
      carente: ["adjetivo"],
      aqui: ["adverbio"],
      veces: ["sustantivo"],
      cantar: ["verbo"],
      locura: ["sustantivo"],
      matematica: ["adjetivo"],
      querer: ["verbo"],
      saber: ["verbo"],
      siguiente: ["adjetivo"],
      nivel: ["sustantivo"],
      loca: ["adjetivo"],
      no: ["adverbio"],
      tonto: ["adjetivo"],
      sino: ["conjuncion"],
      alguno: ["determinante"],
      muy: ["adverbio"],
      cautela: ["sustantivo"],
      ir: ["verbo"],
      astuto: ["adjetivo"],
      alla: ["adverbio"],
      bestias: ["sustantivo"],
      contentar: ["verbo"],
      mil: ["determinante"],
      palabras: ["sustantivo"],
      anorar: ["verbo"]
    };

    function expandirConSinonimos(palabra) {
      const base = palabra.toLowerCase();
      const lista = [base];
      if (sinonimos[base]) {
        lista.push(...sinonimos[base]);
      }
      return lista;
    }

    function elegirDefinicionConExplicacion(definiciones, contexto) {
      const ctxWords = palabrasClave(contexto);
      const setCtx   = new Set(ctxWords);

      let mejorIndice = 0;
      let mejorScore  = -Infinity;
      let mejorExplicacion = {
        exactas: [],
        sinonimos: [],
        categorias: [],
        score: 0
      };

      definiciones.forEach((def, idx) => {
        const palabrasDef = palabrasClave(def);
        let score = 0;
        let exactas    = [];
        let sinos      = [];
        let catsUsadas = [];

        palabrasDef.forEach(p => {
          const base = p.toLowerCase();
          let coincid = null;

          // Coincidencia exacta
          if (setCtx.has(base)) {
            coincid = base;
            score += 2;
            exactas.push(base);
          } else {
            // Coincidencia por sin√≥nimos
            const variantes = expandirConSinonimos(base);
            for (const v of variantes) {
              if (setCtx.has(v)) {
                coincid = v;
                score += 1;
                sinos.push({ palabraDef: base, coincidencia: v });
                break;
              }
            }
          }

          // Pesos por categor√≠a
          if (coincid) {
            const catList = categorias[coincid];
            if (catList) {
              for (const cat of catList) {
                if (pesosCategoria[cat] !== undefined) {
                  const peso = pesosCategoria[cat];
                  score += peso;
                  catsUsadas.push({ palabra: coincid, categoria: cat, peso });
                }
              }
            }
          }
        });

        if (score > mejorScore) {
          mejorScore = score;
          mejorIndice = idx;
          mejorExplicacion = {
            exactas,
            sinonimos: sinos,
            categorias: catsUsadas,
            score
          };
        }
      });

      return {
        indice: mejorIndice,
        explicacion: mejorExplicacion
      };
    }

    // -----------------------
    // RESALTADO EN EL LIBRO
    // -----------------------
    function limpiarResaltado() {
      document.querySelectorAll('#libro .palabra.resaltada').forEach(span => {
        span.classList.remove('resaltada');
      });
    }

    function resaltarCoincidencias(rawWord) {
      const objetivo = normalizarPalabra(rawWord);

      document.querySelectorAll('#libro .palabra').forEach(span => {
        const textoSpan = span.textContent || "";
        if (normalizarPalabra(textoSpan) === objetivo) {
          span.classList.add('resaltada');
        }
      });
    }

    // ---------------------------
    // MOSTRAR DEFINICI√ìN AL CLICK
    // ---------------------------
    function mostrarDefinicion(rawWord, tokenIndex) {
      const clave = obtenerClaveVerbal(rawWord, tokenIndex);
      const entrada =
        diccionario[clave] ||
        diccionarioIdx[normalizarPalabra(clave)];
      const panel = document.getElementById("definicion");

      // 1) Resaltado visual en el texto del libro
      limpiarResaltado();
      resaltarCoincidencias(rawWord);

      // 2) Si no hay entrada en el diccionario
      if (!entrada) {
        panel.innerHTML = `
          <h2>${rawWord}</h2>
          <p class="sin-def">
            Esta palabra a√∫n no tiene definici√≥n en tu diccionario.
            <br><small>(clave interna: ${clave})</small>
          </p>
        `;
        return;
      }

      // 3) Reunir definiciones
      let definiciones = [];
      if (entrada.definicion) definiciones.push(entrada.definicion);
      if (Array.isArray(entrada.definiciones)) {
        definiciones = definiciones.concat(entrada.definiciones);
      }

      if (definiciones.length === 0) {
        panel.innerHTML = `
          <h2>${rawWord}</h2>
          <p class="sin-def">Esta palabra a√∫n no tiene definici√≥n en tu diccionario.</p>
        `;
        return;
      }

      // 4) Contexto local
      const contexto = obtenerContexto(tokenIndex);

      // 5) Elegir acepci√≥n seg√∫n contexto
      let { indice: indiceElegido, explicacion } =
        elegirDefinicionConExplicacion(definiciones, contexto);

      const esPoderVerbal = (clave === "poder-verbo" || clave === "poder");

      // Regla especial para PODER: ‚Äúpuede que / pueda que‚Äù
      if (esPoderVerbal) {
        const norm = normalizarPalabra(rawWord); // puede, pueda, podria, etc.
        const prevTok  = tokensLibro[tokenIndex - 1] || "";
        const nextTok  = tokensLibro[tokenIndex + 1] || "";
        const prevNorm = normalizarPalabra(prevTok);
        const nextNorm = normalizarPalabra(nextTok);

        const esConstruccionPosibilidad =
          (norm === "puede" || norm === "pueda" || norm === "podria") &&
          (nextNorm === "que" || prevNorm === "que");

        if (esConstruccionPosibilidad && definiciones.length >= 2) {
          indiceElegido = 1; // acepci√≥n 2
          explicacion = {
            exactas: [],
            sinonimos: [],
            categorias: [],
            score: 0,
            reglaEspecial:
              "Se detect√≥ la construcci√≥n ¬´puede que / pueda que¬ª, que marca la acepci√≥n de posibilidad."
          };
        }
      }

      // 6) HTML de definiciones
      const htmlDefs = definiciones
        .map((texto, i) => {
          const style = i === indiceElegido ? ' style="color: blue;"' : "";
          return `<p${style}>${texto}</p>`;
        })
        .join("");

      // 7) Explicaci√≥n textual
      let htmlExp = "";
      if (definiciones.length > 1) {
        const partes = [];

        if (explicacion.exactas && explicacion.exactas.length) {
          const unicas = [...new Set(explicacion.exactas)];
          partes.push(`Coincidencias exactas en el contexto: <b>${unicas.join(", ")}</b>.`);
        }

        if (explicacion.sinonimos && explicacion.sinonimos.length) {
          const lista = explicacion.sinonimos
            .map(p => `${p.palabraDef} ‚Üî ${p.coincidencia}`)
            .join(", ");
          partes.push(`Coincidencias por sin√≥nimos: <b>${lista}</b>.`);
        }

        if (explicacion.reglaEspecial) {
          partes.push(explicacion.reglaEspecial);
        }

        if (partes.length) {
          htmlExp = `
            <hr>
            <p style="font-size:0.9em;">
              <strong>Por qu√© escog√≠ esta acepci√≥n:</strong>
              ${partes.join(" ")}
            </p>
          `;
        }
      }

      // 8) Pintar panel
      panel.innerHTML = `
        <h2>${rawWord}</h2>
        ${htmlDefs}
        ${htmlExp}
      `;
    }

    // -----------------------
    // PREPARAR TEXTO DEL LIBRO
    // -----------------------
    function prepararLibro() {
      const fuente = document.getElementById("texto-libro").innerText;
      const contenedorLibro = document.getElementById("libro");

      const tokens = fuente.split(/(\s+)/);
      tokensLibro = [];

      contenedorLibro.innerHTML = "";
      let indiceToken = 0;

      tokens.forEach(token => {
        if (/^\s+$/.test(token)) {
          contenedorLibro.appendChild(document.createTextNode(token));
        } else {
          const span = document.createElement("span");
          span.textContent = token;
          span.className = "palabra";

          const idx = indiceToken;
          span.addEventListener("click", () => {
            mostrarDefinicion(token, idx);
          });

          tokensLibro.push(token);
          indiceToken++;

          contenedorLibro.appendChild(span);
        }
      });
    }

    // Inicializamos al cargar la p√°gina
    prepararLibro();
  </script>
</body>
</html>
