<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Libro + Diccionario</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
      display: flex;
      gap: 1.5rem;
    }

    #contenedor {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      width: 100%;
    }

    #libro {
      line-height: 1.6;
      text-align: justify;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #definicion {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .palabra { cursor: pointer; }
    .palabra:hover { text-decoration: underline; }

    .palabra.resaltada {
      color: blue;
      font-weight: bold;
    }

    h1 { grid-column: 1 / -1; margin-top: 0; }

    .sin-def {
      color: #999;
      font-style: italic;
    }
  </style>
</head>

<body>
<div id="contenedor">

  <h1>Libro del Infinito</h1>

  <!-- TEXTO DEL LIBRO -->
  <pre id="texto-libro" style="display:none;">

 1 es aterrador 16857 El infinito ha dado un plus a la materia. 16858 El infinito es aterrador como el 1. 16859 No se anda con simplezas éste 1. 16860 Si acumularamos los teoremas que tienen por fundamento en el 1, estaríamos hasta los 80 años hablando,  sin vejez ya. 16861 El infinito quiere alzarse con el trofeo del 1. 16862 Sin un contexto, el 1, tiene poco que decir. 16863 El infinito pertenece a un conjunto hiperreal. 16864 Si contamos las veces que infinito ha dado algo a este servidor, no bastaría para comenzar. 16865 El infinito tiene a 1 como un posible resultado de múltiples casos. 16866 Para mostrar un botón. 16867 La raíz infinita de infinito es tendente al 1. 16868 ¿Quién sacó este naipe del codo? 16869 Parece que las operaciones para llegar a ese resultado no son complejas. 16870 Sin complejidad, cero tiene aún más sentido. 16871 El infinito se desglosó en infinito e infinita para llegar a 1. 16872 El infinito es en un desglose 1 sólo sin más añadidos. 
    16873 Parece que añadir indefinidamente buscase un fin. 16874 Parece que añadir 1 al 1 no montara mucho a ojos del infinito. 
    16875 Cuando se llega a esos entornos tan brutales, no tiene caso el 1. 16876 El infinito es 1 y el primero. 16877 Ya esbocé que el 1 es aterrador y partir mi escrito máximo, debe justificar sus decisiones. 16878 Por eso es que en el juego del go, Alfago, demoró de 30 a 40 segundos en responder a la piedra primera acotada por Lee Sedol. 16878 bis La inteligencia dice que para asegurar el fuseki es necesario casi demorar una jugada, que es la más importante.  16879 Que pasara un minuto, también podría ser. 16880 El 1 es tan aterrador, porque no hay destino en la tierra más todavía. 16881 El infinito es vertebrador de los dígitos nombrados. 16882 El infinito es siempre algo que no tiene fin. 16883 Toda la definición de infinito puede ser puesta en lenguaje matemático. 16884 No hay nada que la matemática y sus matemáticos desconozcan del infinito, aún así insisten en que no tiene sentido, esas operaciones que no gustan. 
    16885 Sin el 1, no habría origen. 16886 Es primero el 1 entre 0, el que pone la polémica en la mesa. 16887 Es más todavía, el 1 es origen de todo número, incluyendo el infinito, sí lo creo. 16888 El infinito sigue siendo la vértebra en este universo máximo. 16889 Conseguir el 1 debiera ser el principal objetivo del infinito, pero descreo de ello pronto. 16890 En un plano complejo el 1 es más especial, porque se le añaden cosas, sin dejar de ser 1. 16891 El infinito es matemáticamente perfecto, ya que de matemáticamente puede ser, ya que, por bis, infinito no es existente sin la matemática, y lo de perfecto es claro que el matemático, puede pasar a su dialecto toda la definición, con alguna reticencia. 16892 El infinito me exige a buscar en 1, algo más allá del número meramente. 16893 Muy obtuso seré si llego con que el 1 no es real, en el caso de que cero es denominador. 16894 Algo de verdad tendrá que cero no puede dividir a ningún/algún número. 16895 O quizá esté hablando el miedo del matemático, con decir que no se puede. 16896 Yo prefiero creer en el miedo, que es más lógico ante algo extraño. 16897 El 1 es origen de Google, así como es origen del número de Graham. 16898 Yo no quiero creer eso. 16899 Graham ha desquiciado el 1 con apartarse del sistema numérico decimal. 16900 En infinito 1 es el origen debido. 16901 Pero 1 tiene un poder en multiplicarse con números alteraandolos mínimamente. 16902 El infinito es una ecuación. 16903 Nada en la matemática es cero. 16904 La nada aquí no está. 16905 Si nos vamos a referir a cero, declararemos que es algo por convención. 16906 De sumar 1 a 1 resultó la √2. 16907 ¿Cómo es eso? 16907 Muy pocos recursos se hizo Hipaso de Metaponto, al sumar, simple, a 1 con 1. 16908 El infinito tiene un listado de números que siguen la ley del infinito. Esto es ñañ.16909 El infinito tiene a √2 como su primer elemento. 16910 De ahí saltamos a los números primos bajo raíz. 16911 Todo número primo bajo raíz, deberá ser irracional. 16912 Tratar de aplicar razón a los números primos, quizá esté errado. 16913 El infinito es un número, creo. 16914 El infinito es aterrador, misma cosa pasa con el 1. 16915 Parece que a la usanza de infinito, sumar 1 es algo ridículamente especial. 16916 (1 +1) y bajo raíz se sale de razón. 16917 El 1 no es aterrador, porque es nuestro aliado. 16918 Perder la razón no es algo especial. 16919 Más bien ser razón es lo especial. 16920 Leeré este escrito una y otra vez, porque quiero que tenga una coherencia de 666. 16921 Con que la Iglesias referencie a 666 como el número bestial bastará. 16922 El infinito es un resumen de la existencia. 16923 Partimos con los números de contar. 16924 Me miro la mano con 5 dedos y me pregunto, ¿habrá una correspondencia en la naturaleza? 16925 El infinito se hace desde un 1. 16926 Los matemáticos nos dicen que el universo se hizo del vacío. 16927 Yo me opongo fuertemente a ello. 16928 Antes de la palabra divina, había un ser planeando en el aire del horizonte. 16929 Como abarcando todo. 16930 Quizá fue el infinito transmutado en una tierra preexistente. 16931 Un ser era el que planeaba. 16932 Es común esa idea de que los seres podrían llegar a volar, por alguna potencia salida de sí mismos. 16933 ¿Qué intención tenía Dios en planear 1 en la tierra preexistente? 16934 Dios fue singular en ese momento, y siguió siendo singular todo el tiempo, hasta el futuro mío. 16935 Al menos lleguemos a la frase 17 mil antes de pasar al aterrador 2. 16936 El infinito es un elemento elemental. 16937 Nada avanzaré con eso. 16938 Sin 1, no tendríamos el altisonante universo. 16939 En el cosmos nada hay de unidad, y ello es extraño, ya que 1 está en todo número. 16940 Para empezar el 1 y el número son los divisores de los números primos, excluyendo todo otro foráneo como un número compuesto. 16941 El infinito prefirió negar, antes que decir que su infinito era de 1. 16942 Pudo decir que 1 era su fin, sin embargo, los datos no revelan eso. 16943 Tanto es la definición del infinito que llega al número 3 y 2. 16944 Tres negaciones. 16945 El infinito no tiene 3 fines, sino dos. 16946 Este menosprecio del 1 es característico del carácter de no unificar las cosas primero. 16947 El 1 es aterrador, porque no hay algo bajo el sol que guarde más secretos que el triste número 1. 16948 Su secretismo es pavoroso. 16949 No hay otro objetivo que hacerte ver que infinito es un número real. 16950 Y que lo irreal es el 1. 16951 Sin 1, no tendríamos a 2 ni √2 . 16952 Sumar 1 entre números del 0 al 10, tiene un recorrido asombrosamente grande. 16953 El 1 tiene algo de grandeza en permitir a los humanos buscar unidad. 16954 El infinito es gestor del 1. 16955 Casi que el primero fuera por infinito. 16956 El infinito es un ser que continuamente está amando. 16957 El genio de este escrito es presentar argumentos de la numeridad del infinito y nada más. 16958 El infinito es aterrador como lo es el 1. 16959 Yo sospecho más en 1 que en cero, como la otra cara de la moneda, principiada por infinito. 16960 No hay en cero lo que hay en 1. 16961 Sin unidad, no tiene sentido hablar del
  </pre>

  <div id="libro"></div>

  <div id="definicion">
    <h2>Definición</h2>
    <p>Haz clic en una palabra del libro para ver su definición.</p>
  </div>

</div>
</div>  <!-- cierre del contenedor -->

<button id="btnResumenIA" style="margin-top:20px;">
  Generar resumen cada 200 palabras (IA)
</button>

<div id="resumen" style="margin-top:20px;"></div>

<script>
    
/* -------------------------------------
   FUNCIONES DE NORMALIZACIÓN
------------------------------------- */
function normalizarPalabra(raw = "") {
  return raw
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9ñ]/gi, "");
}

/* -------------------------------------
   DICCIONARIO COMPLETO (FUNCIONAL)
------------------------------------- */
const diccionario = {

  agujero: {
    definiciones: [
      "1.Abertura o hueco en una superficie o en un sólido.",
      "2.De las agujas.",
      "3.Falta inmotivada de plata en una empresa."
    ]
  },

  negro: {
    definiciones: [
      "1.Ausencia total o casi de reflejo luminoso.",
      "2.De color negro.",
      "3.Perteneciente a la raza negra.",
      "4.Ritual en que se invoca al demonio.",
      "5.Del color de carbón, de oscuridad total o la boca de un túnel",
      "6.Muy bronceado.",
      "7.Modo de tratamiento de quienes se quieren.",
      "8.Persona que hace un trabajo intelectual por encargo de otra haciendo todo el esfuerzo.",
      "9.Estado de ánimo triste o pesimista.",
      "10.Género de cine que de trama policiaca en entorno violento."
    ]
  },

  de: {
    definiciones: [
      "1.Indica pertenencia. La paciencia de job.",
      "2.Locuciones adverbiales: Almorzó de pie.",
      "3.Procedencia: Vengo de Aranjuez.",
      "4.Material: vestido de seda.",
      "5.Contenido: vaso de agua.",
      "6.Asunto: trata de la guerra.",
      "7.Causa: murió de viruelas.",
      "8.Naturaleza: hombre de valor.",
      "9.Desde: de Madrid a Toledo.",
      "10.Lejor de pensar.",
      "11.Hipotético: de saberlo vendría.",
      "12.Perífrasis: acaba de pasar.",
      "13.Tiempo: de madrugada.",
      "14.Refuerzo: el bueno de Juan.",
      "15.Ilación: de esto se sigue.",
      "16.Rapidez: beber de un trago.",
      "17.Lástima: ay de los vencidos.",
      "18.A por la 16.",
      "19.Comparación.",
      "20.Para. Gorro de dormir.",
      "21.Por miedo."
    ]
  },

  amanecer: {
    definiciones: [
      "1.Comenzar a verse la luz.",
      "2.Estar en un lugar al amanecer.",
      "3.Nacer figurado.",
      "4.Pasar la noche en vela.",
      "5.Alumbre."
    ]
  },

  manana: {
    definiciones: [
      "1.Parte del día entre amanecer y mediodía.",
      "2.Medianoche a mediodía.",
      "3.El tiempo futuro.",
      "4.El día siguiente."
    ]
  },

  en: {
    definiciones: [
      "1.Tiempo, lugar o modo.",
      "2.Sobre.",
      "3.Ocupación.",
      "4.Tránsito.",
      "5.Tan pronto como.",
      "6.Límite de movimiento."
    ]
  },

  ese: {
    definiciones: [
      "1.Cercano al interlocutor.",
      "2.Mencionado.",
      "3.Menosprecio.",
      "4.Persona que se ha marchado."
    ]
  },

  campo: {
    definiciones: [
      "1.Terreno extenso.",
      "2.Terreno trabajable.",
      "3.Campiña.",
      "4.Terreno de juego.",
      "5.Mitad del campo en fútbol.",
      "6.Término de municipio.",
      "7.Campo de conocimiento.",
      "8.Campo eléctrico.",
      "9.Campo de base de datos.",
      "10.Comarca ocupada por ejército.",
      "11.Ejército.",
      "12.Campo visual."
    ]
  },

  hipotetico: { definicion: "Perteneciente a la hipótesis." },

  vencer: {
    definiciones: [
      "1.Batir al enemigo.",
      "2.Ser superior.",
      "3.Controlar emociones.",
      "4.Superar obstáculos.",
      "5.Atraer a alguien al propio deseo.",
      "6.Subir a un sitio áspero.",
      "7.Cumplirse plazo.",
      "8.Ganar en pelea física."
    ]
  },

  supervitaminar: {
    definiciones: [
      "1.Potenciar algo.",
      "2.Hipertrofiar.",
      "3.Dopar con trampa."
    ]
  },

  "poder-verbo": {
    definiciones: [
      "1.Tener vía libre para hacer a lo quiera.",
      "2.Expresa posibilidad.",
      "3.Ser capaz de vencer a otro.",
      "4.Sufrir impertinencias."
    ]
  },

  "poder-sustantivo": {
    definiciones: [
      "1.Facultad para hacer.",
      "2.Gobierno.",
      "3.Fuerza física de animales.",
      "4.Permiso legal cedido."
    ]
  },

  infinito: {
    definiciones: [
      "1.Que no tiene fin.",
      "2.Ilimitado.",
      "3.Lo que carece de límite."
    ]
  },

  estado: { definiciones: ["1.Condición.", "2.Organización política."] },
  sentido: { definiciones: ["1.Significado.", "2.Función fisiológica."] },
  fin: { definiciones: ["1.Término.", "2.Propósito."] },
  tener: { definiciones: ["1.Poseer.", "2.Sujetar.", "3.Ocurrir."] },
  traer: { definiciones: ["1.Llevar hacia aquí.", "2.Causar."] },
  vejaciones: { definiciones: ["1.Maltrato.", "2.Humillación persistente."] },

  dios: { definiciones: ["1.Ser supremo."] }
};


/* -------------------------------------
   ÍNDICE NORMALIZADO
------------------------------------- */
const diccionarioIdx = {};
for (const [k, v] of Object.entries(diccionario)) {
  diccionarioIdx[normalizarPalabra(k)] = v;
}


/* -------------------------------------
   DETECCIÓN PODER
------------------------------------- */
function tipoPoder(tokens, idx) {
  const palabra = normalizarPalabra(tokens[idx] || "");
  const prev = normalizarPalabra(tokens[idx - 1] || "");
  const next = normalizarPalabra(tokens[idx + 1] || "");

  const conjugaciones = [
    "puedo","puedes","puede","podemos","pueden",
    "podia","podias","podiamos","podian",
    "podra","podras","podremos","podran",
    "podria","podrias","podriamos","podrian",
    "pude","pudiste","pudo","pudimos","pudieron",
    "pueda","puedas","podamos","puedan",
    "pudiera","pudieras","pudieramos","pudieran",
    "pudiese","pudieses","pudiesemos","pudiesen"
  ];
  if (conjugaciones.includes(palabra)) return "verbo";

  const determinantes = [
    "el","la","los","las","un","una","unos","unas",
    "mi","mis","tu","tus","su","sus",
    "este","esta","estos","estas",
    "ese","esa","esos","esas",
    "aquel","aquella","aquellos","aquellas",
    "del","al"
  ];
  if (palabra === "poder" && determinantes.includes(prev)) return "sustantivo";

  if (palabra === "poder" && prev === "de") {
    if (next.endsWith("ar") || next.endsWith("er") || next.endsWith("ir"))
      return "verbo";
    return "sustantivo";
  }

  if (palabra === "poder" && (next.endsWith("ar") || next.endsWith("er") || next.endsWith("ir")))
    return "verbo";

  return null;
}


/* -------------------------------------
   LEMATIZACIÓN
------------------------------------- */

const verbLemmaMap = {
  "puedo": "poder", "puedes": "poder", "puede": "poder",
  "podemos": "poder", "pueden": "poder",
  "podia": "poder", "podias": "poder", "podiamos": "poder", "podian": "poder",
  "podra": "poder", "podras": "poder", "podremos": "poder", "podran": "poder",
  "podria": "poder", "podrias": "poder", "podriamos": "poder", "podrian": "poder",
  "pude": "poder", "pudiste": "poder", "pudo": "poder", "pudimos": "poder", "pudieron": "poder",
  "pueda": "poder", "puedas": "poder", "podamos": "poder", "puedan": "poder",
  "pudiera": "poder", "pudieras": "poder", "pudieramos": "poder", "pudieran": "poder",
  "pudiese": "poder", "pudieses": "poder", "pudiesemos": "poder", "pudiesen": "poder",
  "creo": "crear"
};

const cliticEndings = [
  "melo","mela","melos","melas",
  "telo","tela","telos","telas",
  "selo","sela","selos","selas",
  "noslo","nosla","noslos","noslas",
  "oslo","osla","oslos","oslas",
  "me","te","se","lo","la","los","las","le","les","nos","os"
];

function stripClitics(word) {
  let w = word;
  let changed = true;
  while (changed) {
    changed = false;
    for (const cl of cliticEndings) {
      if (w.endsWith(cl) && w.length > cl.length + 1) {
        w = w.slice(0, -cl.length);
        changed = true;
        break;
      }
    }
  }
  return w;
}

function guessInfinitive(w) {
  if (verbLemmaMap[w]) return verbLemmaMap[w];

  if (w.endsWith("se")) {
    const base = w.slice(0, -2);
    if (diccionario[base]) return base;
  }

  if (w.endsWith("o")) {
    const stem = w.slice(0, -1);
    const candAr = stem + "ar";
    if (diccionario[candAr]) return candAr;
  }

  if (w.endsWith("aba") || w.endsWith("abas") || w.endsWith("aban")) {
    const stem = w.replace(/aba(s|n)?$/, "");
    const candAr = stem + "ar";
    if (diccionario[candAr]) return candAr;
  }

  if (w.endsWith("ando")) {
    const stem = w.slice(0, -4);
    const cand = stem + "ar";
    if (diccionario[cand]) return cand;
  }

  if (w.endsWith("iendo")) {
    const stem = w.slice(0, -5);
    const candEr = stem + "er";
    const candIr = stem + "ir";
    if (diccionario[candEr]) return candEr;
    if (diccionario[candIr]) return candIr;
  }

  if (w.endsWith("ar") || w.endsWith("er") || w.endsWith("ir"))
    return w;

  return w;
}

/* -------------------------------------
   TOKENIZACIÓN Y CONSTRUCCIÓN DEL LIBRO
------------------------------------- */

let tokensLibro = [];

function prepararLibro() {
  const fuente = document.getElementById("texto-libro").innerText;
  const contenedorLibro = document.getElementById("libro");

  const tokens = fuente.split(/(\s+)/);
  tokensLibro = [];

  contenedorLibro.innerHTML = "";
  let indiceToken = 0;

  tokens.forEach(token => {
    if (/^\s+$/.test(token)) {
      contenedorLibro.appendChild(document.createTextNode(token));
    } else {
      const span = document.createElement("span");
      span.textContent = token;
      span.className = "palabra";

      const idx = indiceToken;
      span.addEventListener("click", () => mostrarDefinicion(token, idx));

      tokensLibro.push(token);
      indiceToken++;

      contenedorLibro.appendChild(span);
    }
  });
}

/* -------------------------------------
   CONTEXTO
------------------------------------- */

function obtenerContexto(idx) {
  let inicio = idx;
  let fin = idx;

  while (inicio > 0) {
    const t = tokensLibro[inicio];
    if (/[.!?]/.test(t)) {
      inicio++;
      break;
    }
    inicio--;
  }

  while (fin < tokensLibro.length - 1) {
    const t = tokensLibro[fin];
    if (/[.!?]/.test(t)) break;
    fin++;
  }

  return tokensLibro.slice(inicio, fin + 1).join(" ");
}

/* -------------------------------------
   PALABRAS CLAVE
------------------------------------- */

function limpiarTexto(texto) {
  return texto
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9ñ\s]/gi, " ");
}

const stopwords = new Set([
  "el","la","los","las","un","una","unos","unas",
  "lo","al","del",
  "de","a","en","por","para","con","sin","sobre",
  "y","o","u","ni",
  "que","se","su","sus","mi","mis","tu","tus",
  "este","esta","estos","estas","ese","esa","esos","esas",
  "aquel","aquella","aquellos","aquellas"
]);

function palabrasClave(texto) {
  return limpiarTexto(texto)
    .split(/\s+/)
    .filter(w => w.length > 2 && !stopwords.has(w));
}

/* -------------------------------------
   SINÓNIMOS
------------------------------------- */

const sinonimos = {
  vencer: ["ganar","derrotar","triunfar","vencer"],
  sufrir: ["aguantar","soportar","tolerar","padecer","sufrir"],
  impertinencias: ["vejaciones","abusos","humillaciones","maltratos"],
  posibilidad: ["posibilidad","quizas","talvez","acaso","hipotetico","probable","eventual"]
};

const pesosCategoria = {
  verbo: 2,
  sustantivo: 1,
  adjetivo: 0,
  adverbio: -1,
  pronombre: -2,
  determinante: -3,
  preposicion: -4,
  conjuncion: -5,
  interjeccion: -6
};

const categorias = {
  infinito: ["sustantivo","adjetivo"],
  poder: ["sustantivo","verbo"],
  amanecer: ["verbo"],
  manana: ["adverbio","sustantivo"],
  campo: ["sustantivo"],
  hipotetico: ["adjetivo"],
  vencer: ["verbo"],
  dios: ["sustantivo"],
  propio: ["adjetivo"],
  juego: ["sustantivo"],
  fin: ["sustantivo"],
  aguantar: ["verbo"],
  vejaciones: ["sustantivo"],
  traer: ["verbo"],
  tener: ["verbo"],
  estado: ["sustantivo"],
  sentido: ["sustantivo"]
};


/* -------------------------------------
   EXPANSIÓN DE SINÓNIMOS
------------------------------------- */
function expandirConSinonimos(p) {
  const base = p.toLowerCase();
  const lista = [base];
  if (sinonimos[base]) lista.push(...sinonimos[base]);
  return lista;
}

/* -------------------------------------
   ELECCIÓN DE DEFINICIÓN
------------------------------------- */
function elegirDefinicionConExplicacion(definiciones, contexto) {
  const ctxWords = palabrasClave(contexto);
  const setCtx = new Set(ctxWords);

  let mejorIndice = 0;
  let mejorScore = -Infinity;
  let mejorExplicacion = { exactas: [], sinonimos: [], categorias: [], score: 0 };

  definiciones.forEach((def, idx) => {
    const palabrasDef = palabrasClave(def);
    let score = 0;
    let exactas = [];
    let sinos = [];
    let catsUsadas = [];

    palabrasDef.forEach(p => {
      const base = p.toLowerCase();
      let coincid = null;

      if (setCtx.has(base)) {
        coincid = base;
        score += 2;
        exactas.push(base);
      } else {
        const variantes = expandirConSinonimos(base);
        for (const v of variantes) {
          if (setCtx.has(v)) {
            coincid = v;
            score += 1;
            sinos.push({ palabraDef: base, coincidencia: v });
            break;
          }
        }
      }

      if (coincid) {
        const catList = categorias[coincid];
        if (catList) {
          for (const cat of catList) {
            if (pesosCategoria[cat] !== undefined) {
              const peso = pesosCategoria[cat];
              score += peso;
              catsUsadas.push({ palabra: coincid, categoria: cat, peso });
            }
          }
        }
      }
    });

    if (score > mejorScore) {
      mejorScore = score;
      mejorIndice = idx;
      mejorExplicacion = { exactas, sinonimos: sinos, categorias: catsUsadas, score };
    }
  });

  return { indice: mejorIndice, explicacion: mejorExplicacion };
}

/* -------------------------------------
   RESALTADO
------------------------------------- */

function limpiarResaltado() {
  document.querySelectorAll("#libro .palabra.resaltada")
    .forEach(e => e.classList.remove("resaltada"));
}

function resaltarCoincidencias(rawWord) {
  const objetivo = normalizarPalabra(rawWord);
  document.querySelectorAll("#libro .palabra").forEach(span => {
    const textoSpan = span.textContent || "";
    if (normalizarPalabra(textoSpan) === objetivo)
      span.classList.add("resaltada");
  });
}

/* -------------------------------------
   MUESTRA DE DEFINICIÓN
------------------------------------- */

function obtenerClaveVerbal(rawWord, idx) {
  const original = rawWord.trim();

  if (original.toLowerCase().startsWith("dios")) return "dios";

  if (original === "creó" || original === "Creó")
    return diccionario["crear"] ? "crear" : original;

  let w = normalizarPalabra(original);
  w = stripClitics(w);
  const lemma = guessInfinitive(w);

  if (lemma === "poder") {
    const tipo = tipoPoder(tokensLibro, idx);
    if (tipo === "verbo") return "poder-verbo";
    if (tipo === "sustantivo") return "poder-sustantivo";
    return "poder-verbo";
  }

  return lemma;
}

function mostrarDefinicion(rawWord, idx) {
  const clave = obtenerClaveVerbal(rawWord, idx);

  const entrada =
    diccionario[clave] ||
    diccionarioIdx[normalizarPalabra(clave)];

  const panel = document.getElementById("definicion");

  limpiarResaltado();
  resaltarCoincidencias(rawWord);

  if (!entrada) {
    panel.innerHTML = `
      <h2>${rawWord}</h2>
      <p class="sin-def">
        Esta palabra no tiene definición aún.
        <br><small>(clave interna: ${clave})</small>
      </p>`;
    return;
  }

  let definiciones = [];
  if (entrada.definicion) definiciones.push(entrada.definicion);
  if (entrada.definiciones) definiciones.push(...entrada.definiciones);

  const contexto = obtenerContexto(idx);

  let { indice: indiceElegido, explicacion } =
    elegirDefinicionConExplicacion(definiciones, contexto);

  const htmlDefs = definiciones
    .map((d, i) => `<p${i === indiceElegido ? ' style="color:blue;"' : ''}>${d}</p>`)
    .join("");

  let htmlExp = "";
  const partes = [];

  if (explicacion.exactas.length)
    partes.push("Coincidencias exactas: <b>" + explicacion.exactas.join(", ") + "</b>.");

  if (explicacion.sinonimos.length)
    partes.push("Sinónimos: <b>" +
      explicacion.sinonimos.map(s => `${s.palabraDef} ↔ ${s.coincidencia}`).join(", ") +
      "</b>.");

  if (partes.length)
    htmlExp = `<hr><p style="font-size:0.9em;"><strong>Razón:</strong> ${partes.join(" ")}</p>`;

  panel.innerHTML = `<h2>${rawWord}</h2>${htmlDefs}${htmlExp}`;
}

/* -------------------------------------
   INICIO
------------------------------------- */

prepararLibro();
// =====================================================
// RESÚMENES AUTOMÁTICOS CON IA (Cloudflare Worker + OpenAI)
// =====================================================

// URL de tu Worker
const URL_RESUMEN = "https://broad-river-a64a.diosydiosperobienomal.workers.dev";

// Divide el libro en bloques de 200 palabras
function dividirEnBloques(texto, tam = 200) {
  const palabras = texto.split(/\s+/).filter(p => p.trim().length > 0);
  const bloques = [];
  for (let i = 0; i < palabras.length; i += tam) {
    bloques.push(palabras.slice(i, i + tam).join(" "));
  }
  return bloques;
}

// Llama al Worker para resumir un bloque
async function resumirConIA(bloque) {
  const res = await fetch(URL_RESUMEN, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ texto: bloque })
  });

  if (!res.ok) return "Error al resumir";

  const data = await res.json();
  return data.resumen || "Sin resumen";
}

// Genera los resúmenes para todos los bloques
async function generarResumenCada200ConIA() {
  const texto = document.getElementById("texto-libro").innerText;
  const salida = document.getElementById("resumen");
  const bloques = dividirEnBloques(texto, 200);

  salida.innerHTML = "<h2>Resúmenes automáticos generados por IA</h2>";

  for (let i = 0; i < bloques.length; i++) {
    const resumen = await resumirConIA(bloques[i]);
    salida.innerHTML += `
      <div style="margin-bottom:1rem; padding:0.5rem; border-left:3px solid #999;">
        <h3>Bloque ${i + 1} (palabras ${i * 200} – ${(i + 1) * 200})</h3>
        <p><em>Resumen generado automáticamente</em></p>
        <p>${resumen}</p>
      </div>
    `;
  }
}

// Conecta el botón al cargar la página
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("btnResumenIA");
  if (btn) btn.addEventListener("click", generarResumenCada200ConIA);
});
</script>

</body>
</html>
