<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Libro + Diccionario</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
      display: flex;
      gap: 1.5rem;
    }

    #contenedor {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      width: 100%;
    }

    #libro {
      line-height: 1.6;
      text-align: justify;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #definicion {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .palabra { cursor: pointer; }
    .palabra:hover { text-decoration: underline; }

    .palabra.resaltada {
      color: blue;
      font-weight: bold;
    }

    h1 {
      grid-column: 1 / -1;
      margin-top: 0;
    }

    .sin-def {
      color: #999;
      font-style: italic;
    }
  </style>
</head>

<body>
<div id="contenedor">

  <h1>Libro del Infinito</h1>

  <!-- Texto original del libro -->
  <pre id="texto-libro" style="display:none;">
4296 El poder del estado en infinito no tiene sentido.
4297 El infinito de poder puede.
4298 El infinito puede que amanezca mañana en ese campo hipotético.
4299 El infinito podrá vencer a dios en su propio juego, el fin.
4300 No puedo aguantar las vejaciones que trae tener un fin.
  </pre>

  <!-- Libro renderizado -->
  <div id="libro"></div>

  <!-- Panel de definición -->
  <div id="definicion">
    <h2>Definición</h2>
    <p>Haz clic en una palabra del libro para ver su definición.</p>
  </div>

</div>

<script>
/* ------------------------------
   Funciones base
------------------------------ */

function normalizarPalabra(raw = "") {
  return raw
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9ñ]/gi, "");
}

/* ------------------------------
   Diccionario del usuario
------------------------------ */

const diccionario = {

  agujero: {
    definiciones: [
      "1.Abertura o hueco en una superficie o en un sólido.",
      "2.De las agujas.",
      "3.Falta inmotivada de plata en una empresa."
    ]
  },

  negro: {
    definiciones: [
      "1.Ausencia total o casi de reflejo luminoso.",
      "2.De color negro.",
      "3.Perteneciente a la raza negra.",
      "4.Ritual en que se invoca al demonio.",
      "5.Del color de carbón, de oscuridad total o la boca de un túnel",
      "6.Muy bronceado.",
      "7.Modo de tratamiento de quienes se quieren.",
      "8.Persona que hace un trabajo intelectual por encargo de otra haciendo todo el esfuerzo.",
      "9.Estado de ánimo triste o pesimista.",
      "10.Género de cine que de trama policiaca en entorno violento."
    ]
  },

  de: {
    definiciones: [
      "1.Indica pertenencia. La paciencia de job.",
      "2.Para hacer diferentes locuciones adverbiales de modo. Almorzó de pie.",
      "3.Indica de dónde procede alguien. Vengo de Aranjuez.",
      "4.Indica el material del que está creado algo. El vestido de seda.",
      "5.Para indicar lo que tiene algo. Un vaso de agua.",
      "6.Indica asunto. Este libro trata de la última guerra.",
      "7.Indica la causa de algo. Murió de viruelas.",
      "8.Usado para expresar la naturaleza de algo. Hombre de valor.",
      "9.Desde. De Madrid a Toledo.",
      "10.Precedida de adverbio y seguida de infinitivo. Lejos de pensar.",
      "11.Seguido de infinitivo con peso de hipótesis. De saberlo antes, habría venido.",
      "12.Llenado de verbos. Acaba de pasar.",
      "13.Usado con ciertos nombres para indicar el tiempo en que sucede. Lo hizo de madrugada.",
      "14.Para refortalecer un calificativo. El bueno de juan.",
      "15.Usado como indicación de ilacion. De esto se sigue.",
      "16.Indica la veloz ejecución de algo. Se bebió de un trago la tisana.",
      "17.Expresion de lástima. Ay de los vencidos.",
      "18.Llenado de preposiciones. A por la 16.",
      "19.Para introducir una comparación. He comido más de lo debido.",
      "20.Para. Gorro de dormir.",
      "21.Por. Lo hice de miedo."
    ]
  },

  amanecer: {
    definiciones: [
      "1.Comenzar a verse la luz del día.",
      "2.Estar en un lugar o situacion al verse la luz del día.",
      "3.Nacer en figurado.",
      "4.Recorrer la noche insomne.",
      "5.Alumbre."
    ]
  },

  manana: {
    definiciones: [
      "1.Parte del día entre el amanecer y el mediodía.",
      "2.Parte del día entre la medianoche y el mediodía.",
      "3.Tiempo que viene.",
      "4.El día inmediatamente posterior al de hoy."
    ]
  },

  en: {
    definiciones: [
      "1.Indica en qué tiempo, lugar o modo se realiza lo que habla el verbo.",
      "2.Sobre.",
      "3.Indica la ocupación de alguien.",
      "4.Indica situación de tránsito.",
      "5.Tan pronto como.",
      "6.Denota el límite de algún verbo de movimiento."
    ]
  },

  ese: {
    definiciones: [
      "1.Que está cercano del individuo con el que se conversa.",
      "2.Que se menciona o se mencionara.",
      "3.Señala menosprecio por algo o por persona.",
      "4.Señala una persona que está lejana o que se marchó."
    ]
  },

  campo: {
    definiciones: [
      "1.Terreno extenso.",
      "2.Terreno que puede trabajarse.",
      "3.En oposición a sierra.",
      "4.Terreno de juego.",
      "5.Mitad del terreno que se defiende.",
      "6.Término de municipio.",
      "7.Reino imaginario de conocimiento.",
      "8.Región del espacio donde está definida una magnitud.",
      "9.Campo de base de datos.",
      "10.Comarca ocupada por ejércitos.",
      "11.Ejército.",
      "12.Redondel visual del ojo."
    ]
  },

  hipotetico: { definicion: "Perteneciente a la hipótesis." },

  supervitaminar: {
    definiciones: [
      "1.Potenciar algo por un agente.",
      "2.Hipertrofiar algo hasta lo grotesco.",
      "3.Dopar por trampa."
    ]
  },

  poder-verbo: {
    definiciones: [
      "1.Tener vía libre para hacer a lo quiera.",
      "2.Expresa posibilidad de que ocurra algo.",
      "3.Ser capaz de vencer a otro.",
      "4.Ocupado de manera negativa: Sufrir las impertinencias de alguien."
    ]
  },

  poder-sustantivo: {
    definiciones: [
      "1.Facultad para hacer.",
      "2.Gobierno en un Estado.",
      "3.Capacidad física de las bestias.",
      "4.Permiso que se cede de alguien a alguien."
    ]
  }

};


/* -------------------------------------------------------
   Creación de índice normalizado (agujero = AGUJERO etc.)
-------------------------------------------------------- */
const diccionarioIdx = {};
for (const [k, v] of Object.entries(diccionario)) {
  diccionarioIdx[normalizarPalabra(k)] = v;
}


/* -------------------------------------------------------
   Detección especial de PODER
-------------------------------------------------------- */

function tipoPoder(tokens, idx) {
  const palabra = normalizarPalabra(tokens[idx] || "");
  const prev = normalizarPalabra(tokens[idx - 1] || "");
  const next = normalizarPalabra(tokens[idx + 1] || "");

  const conjugaciones = [
    "puedo","puedes","puede","podemos","pueden",
    "podia","podias","podiamos","podian",
    "podra","podras","podremos","podran",
    "podria","podrias","podriamos","podrian",
    "pude","pudiste","pudo","pudimos","pudieron",
    "pueda","puedas","podamos","puedan",
    "pudiera","pudieras","pudieramos","pudieran",
    "pudiese","pudieses","pudiesemos","pudiesen"
  ];
  if (conjugaciones.includes(palabra)) return "verbo";

  const determinantes = [
    "el","la","los","las","un","una","unos","unas",
    "mi","mis","tu","tus","su","sus",
    "este","esta","estos","estas",
    "ese","esa","esos","esas",
    "aquel","aquella","aquellos","aquellas",
    "del","al"
  ];
  if (palabra === "poder" && determinantes.includes(prev)) return "sustantivo";

  if (palabra === "poder" && prev === "de") {
    if (next.endsWith("ar") || next.endsWith("er") || next.endsWith("ir"))
      return "verbo";
    return "sustantivo";
  }

  if (
    palabra === "poder" &&
    (next.endsWith("ar") || next.endsWith("er") || next.endsWith("ir"))
  ) return "verbo";

  return null;
}


/* -------------------------------------------------------
   Lematizador simple
-------------------------------------------------------- */

const verbLemmaMap = {
  "puedo": "poder", "puedes": "poder", "puede": "poder",
  "podemos": "poder", "pueden": "poder",
  "podia": "poder", "podias": "poder", "podiamos": "poder", "podian": "poder",
  "podra": "poder", "podras": "poder", "podremos": "poder", "podran": "poder",
  "podria": "poder", "podrias": "poder", "podriamos": "poder", "podrian": "poder",
  "pude": "poder", "pudiste": "poder", "pudo": "poder", "pudimos": "poder", "pudieron": "poder",
  "pueda": "poder", "puedas": "poder", "podamos": "poder", "puedan": "poder",
  "pudiera": "poder", "pudieras": "poder", "pudieramos": "poder", "pudieran": "poder",
  "pudiese": "poder", "pudieses": "poder", "pudiesemos": "poder", "pudiesen": "poder",
  "creo": "crear"
};

const cliticEndings = [
  "melo","mela","melos","melas",
  "telo","tela","telos","telas",
  "selo","sela","selos","selas",
  "noslo","nosla","noslos","noslas",
  "oslo","osla","oslos","oslas",
  "me","te","se","lo","la","los","las","le","les","nos","os"
];

function stripClitics(word) {
  let w = word;
  let changed = true;
  while (changed) {
    changed = false;
    for (const cl of cliticEndings) {
      if (w.endsWith(cl) && w.length > cl.length + 1) {
        w = w.slice(0, -cl.length);
        changed = true;
        break;
      }
    }
  }
  return w;
}

function guessInfinitive(w) {
  if (verbLemmaMap[w]) return verbLemmaMap[w];

  if (w.endsWith("se")) {
    const base = w.slice(0, -2);
    if (diccionario[base]) return base;
  }

  if (w.endsWith("o")) {
    const stem = w.slice(0, -1);
    const candAr = stem + "ar";
    if (diccionario[candAr]) return candAr;
  }

  if (w.endsWith("aba") || w.endsWith("abas") || w.endsWith("aban")) {
    const stem = w.replace(/aba(s|n)?$/, "");
    const candAr = stem + "ar";
    if (diccionario[candAr]) return candAr;
  }

  if (w.endsWith("ando")) {
    const stem = w.slice(0, -4);
    const cand = stem + "ar";
    if (diccionario[cand]) return cand;
  }

  if (w.endsWith("iendo")) {
    const stem = w.slice(0, -5);
    const candEr = stem + "er";
    const candIr = stem + "ir";
    if (diccionario[candEr]) return candEr;
    if (diccionario[candIr]) return candIr;
  }

  if (w.endsWith("ar") || w.endsWith("er") || w.endsWith("ir")) return w;

  return w;
}

/* -------------------------------------------------------
   Construcción del texto interactivo
-------------------------------------------------------- */

let tokensLibro = [];

function obtenerClaveVerbal(rawWord, indiceTokenReal = null) {
  const original = rawWord.trim();

  if (original.toLowerCase().startsWith("dios")) return "dios";

  if (original === "creó" || original === "Creó") {
    if (diccionario["crear"]) return "crear";
  }

  let w = normalizarPalabra(original);
  w = stripClitics(w);
  const lemma = guessInfinitive(w);

  if (lemma === "poder") {
    let idx = indiceTokenReal;

    if (idx == null) {
      idx = tokensLibro.findIndex(t => normalizarPalabra(t) === "poder");
    }

    if (idx >= 0) {
      const tipoPod = tipoPoder(tokensLibro, idx);

      if (tipoPod === "verbo") return "poder-verbo";
      if (tipoPod === "sustantivo") return "poder-sustantivo";
    }

    return "poder-verbo";
  }

  return lemma;
}

/* -------------------------------------------------------
   Contexto y extracción de palabras clave
-------------------------------------------------------- */

function obtenerContexto(idx) {
  let inicio = idx;
  let fin = idx;

  while (inicio > 0) {
    const t = tokensLibro[inicio];
    if (/[.!?]/.test(t)) {
      inicio++;
      break;
    }
    inicio--;
  }

  while (fin < tokensLibro.length - 1) {
    const t = tokensLibro[fin];
    if (/[.!?]/.test(t)) {
      break;
    }
    fin++;
  }

  return tokensLibro.slice(inicio, fin + 1).join(" ");
}

function limpiarTexto(texto) {
  return texto
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9ñ\s]/gi, " ");
}

const stopwords = new Set([
  "el","la","los","las","un","una","unos","unas",
  "lo","al","del",
  "de","a","en","por","para","con","sin","sobre",
  "y","o","u","ni",
  "que","se","su","sus","mi","mis","tu","tus",
  "este","esta","estos","estas","ese","esa","esos","esas",
  "aquel","aquella","aquellos","aquellas"
]);

function palabrasClave(texto) {
  return limpiarTexto(texto)
    .split(/\s+/)
    .filter(w => w.length > 2 && !stopwords.has(w));
}

const sinonimos = {
  vencer: ["ganar","derrotar","triunfar","vencer"],
  sufrir: ["aguantar","soportar","tolerar","padecer","sufrir"],
  impertinencias: ["vejaciones","abusos","humillaciones","maltratos"],
  posibilidad: ["posibilidad","quizas","talvez","acaso","hipotetico","probable","eventual"]
};

const pesosCategoria = {
  verbo: 2,
  sustantivo: 1,
  adjetivo: 0,
  adverbio: -1,
  pronombre: -2,
  determinante: -3,
  preposicion: -4,
  conjuncion: -5,
  interjeccion: -6
};

const categorias = {
  infinito: ["sustantivo","adjetivo"],
  poder: ["sustantivo","verbo"],
  amanecer: ["verbo"],
  manana: ["adverbio","sustantivo"],
  campo: ["sustantivo"],
  hipotetico: ["adjetivo"],
  vencer: ["verbo"],
  dios: ["sustantivo"],
  propio: ["adjetivo"],
  juego: ["sustantivo"],
  fin: ["sustantivo"],
  aguantar: ["verbo"],
  vejaciones: ["sustantivo"],
  traer: ["verbo"],
  tener: ["verbo"],
  estado: ["sustantivo"],
  sentido: ["sustantivo"]
};

function expandirConSinonimos(p) {
  const base = p.toLowerCase();
  const lista = [base];
  if (sinonimos[base]) lista.push(...sinonimos[base]);
  return lista;
}

function elegirDefinicionConExplicacion(definiciones, contexto) {
  const ctxWords = palabrasClave(contexto);
  const setCtx = new Set(ctxWords);

  let mejorIndice = 0;
  let mejorScore = -Infinity;
  let mejorExplicacion = { exactas: [], sinonimos: [], categorias: [], score: 0 };

  definiciones.forEach((def, idx) => {
    const palabrasDef = palabrasClave(def);
    let score = 0;
    let exactas = [];
    let sinos = [];
    let catsUsadas = [];

    palabrasDef.forEach(p => {
      const base = p.toLowerCase();
      let coincid = null;

      if (setCtx.has(base)) {
        coincid = base;
        score += 2;
        exactas.push(base);
      } else {
        const variantes = expandirConSinonimos(base);
        for (const v of variantes) {
          if (setCtx.has(v)) {
            coincid = v;
            score += 1;
            sinos.push({ palabraDef: base, coincidencia: v });
            break;
          }
        }
      }

      if (coincid) {
        const catList = categorias[coincid];
        if (catList) {
          for (const cat of catList) {
            if (pesosCategoria[cat] !== undefined) {
              const peso = pesosCategoria[cat];
              score += peso;
              catsUsadas.push({ palabra: coincid, categoria: cat, peso });
            }
          }
        }
      }
    });

    if (score > mejorScore) {
      mejorScore = score;
      mejorIndice = idx;
      mejorExplicacion = { exactas, sinonimos: sinos, categorias: catsUsadas, score };
    }
  });

  return { indice: mejorIndice, explicacion: mejorExplicacion };
}

/* -------------------------------------------------------
   Resaltado
-------------------------------------------------------- */

function limpiarResaltado() {
  document.querySelectorAll("#libro .palabra.resaltada")
    .forEach(e => e.classList.remove("resaltada"));
}

function resaltarCoincidencias(rawWord) {
  const objetivo = normalizarPalabra(rawWord);
  document.querySelectorAll("#libro .palabra").forEach(span => {
    const textoSpan = span.textContent || "";
    if (normalizarPalabra(textoSpan) === objetivo)
      span.classList.add("resaltada");
  });
}

/* -------------------------------------------------------
   Mostrar definición
-------------------------------------------------------- */

function mostrarDefinicion(rawWord, tokenIndex) {
  const clave = obtenerClaveVerbal(rawWord, tokenIndex);
  const entrada = diccionario[clave] || diccionarioIdx[normalizarPalabra(clave)];

  const panel = document.getElementById("definicion");

  limpiarResaltado();
  resaltarCoincidencias(rawWord);

  if (!entrada) {
    panel.innerHTML = `
      <h2>${rawWord}</h2>
      <p class="sin-def">
        Esta palabra aún no tiene definición en tu diccionario.
        <br><small>(clave interna: ${clave})</small>
      </p>`;
    return;
  }

  let definiciones = [];
  if (entrada.definicion) definiciones.push(entrada.definicion);
  if (Array.isArray(entrada.definiciones)) definiciones.push(...entrada.definiciones);

  if (definiciones.length === 0) {
    panel.innerHTML = `
      <h2>${rawWord}</h2>
      <p class="sin-def">Esta palabra aún no tiene definición.</p>`;
    return;
  }

  const contexto = obtenerContexto(tokenIndex);
  let { indice: indiceElegido, explicacion } =
    elegirDefinicionConExplicacion(definiciones, contexto);

  const esPoderVerbal = (clave === "poder-verbo" || clave === "poder");

  if (esPoderVerbal) {
    const norm = normalizarPalabra(rawWord);
    const prevNorm = normalizarPalabra(tokensLibro[tokenIndex - 1] || "");
    const nextNorm = normalizarPalabra(tokensLibro[tokenIndex + 1] || "");

    const esPosibilidad =
      (norm === "puede" || norm === "pueda" || norm === "podria") &&
      (nextNorm === "que" || prevNorm === "que");

    if (esPosibilidad && definiciones.length >= 2) {
      indiceElegido = 1;
      explicacion = {
        exactas: [],
        sinonimos: [],
        categorias: [],
        score: 0,
        reglaEspecial: "Construcción «puede que / pueda que» detectada → posibilidad."
      };
    }
  }

  const htmlDefs = definiciones
    .map((texto, i) => `<p${i === indiceElegido ? ' style="color:blue;"' : ''}>${texto}</p>`)
    .join("");

  let htmlExp = "";
  const partes = [];

  if (explicacion.exactas.length)
    partes.push("Coincidencias exactas: <b>" + explicacion.exactas.join(", ") + "</b>.");

  if (explicacion.sinonimos.length)
    partes.push("Sinónimos: <b>" +
      explicacion.sinonimos.map(s => `${s.palabraDef} ↔ ${s.coincidencia}`).join(", ") +
      "</b>.");

  if (explicacion.reglaEspecial)
    partes.push(explicacion.reglaEspecial);

  if (partes.length) {
    htmlExp = `<hr><p style="font-size:0.9em;"><strong>Razón:</strong> ${partes.join(" ")}</p>`;
  }

  panel.innerHTML = `<h2>${rawWord}</h2>${htmlDefs}${htmlExp}`;
}

/* -------------------------------------------------------
   Construcción del libro
-------------------------------------------------------- */

function prepararLibro() {
  const fuente = document.getElementById("texto-libro").innerText;
  const contenedorLibro = document.getElementById("libro");

  const tokens = fuente.split(/(\s+)/);
  tokensLibro = [];

  contenedorLibro.innerHTML = "";
  let indiceToken = 0;

  tokens.forEach(token => {
    if (/^\s+$/.test(token)) {
      contenedorLibro.appendChild(document.createTextNode(token));
    } else {
      const span = document.createElement("span");
      span.textContent = token;
      span.className = "palabra";

      const idx = indiceToken;
      span.addEventListener("click", () => mostrarDefinicion(token, idx));

      tokensLibro.push(token);
      indiceToken++;

      contenedorLibro.appendChild(span);
    }
  });
}

prepararLibro();

</script>

</body>
</html>
